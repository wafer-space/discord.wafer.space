==============================================================
Guild: wafer.space Community
Channel: üèóÔ∏è - Designing / project-template
After: 12/22/2025 17:34
==============================================================

[12/22/2025 17:53] polyfractal
@Leo Moser (mole99) (not-important-question): I'm trying to familiarize myself with how LibreLane/OpenRoad works. In `gf180mcu/flows/chip.py` I see a list of steps that are executed for the whole flow. Then in `gf180mcu/steps/*` all the actual step processing logic and config/parameters lives, correct?

So when you add a `OpenROAD.Floorplan` step to `chip.py`, the corresponding logic is defined in the `Floorplan(OpenROADStep)` class residing in `steps/openroad.py`  Is that the gist of how it works?

context: was investigating adding an optional `rtl_macro_placer ` step to the flow  (ala https://github.com/librelane/librelane/issues/537).  Placing macros by hand was super tedious for me, and probably terrible layout performance üòÖ


[12/22/2025 17:58] ravenslofty
yes, that's roughly correct


[12/22/2025 17:59] ravenslofty
but you don't need to dump your plugin into there


[12/22/2025 17:59] ravenslofty
for example, I wanted to play around with openroad's `rmp` step


[12/22/2025 17:59] ravenslofty
```python
from decimal import Decimal
import os
from typing import Literal, Optional, Tuple

from librelane.steps.openroad import Step, TclStep, OpenROADStep, CompositeStep, State, Variable, ViewsUpdate, MetricsUpdate, dpl_variables
from librelane.common import get_script_dir, process_list_file

@Step.factory.register()
class RMP(OpenROADStep):
    id = "OpenROAD.RMP"
    name = "Restructure RMP"
    version = "0.1.0"

    config_vars = OpenROADStep.config_vars + dpl_variables + [
        Variable(
            "RMP_CORNER",
            Optional[str],
            description="IPVT corner to use during restructure. If unspecified, the value for `DEFAULT_CORNER` from the PDK will be used.",
            default="max_ss_125C_4v50"
        ),
        Variable(
            "RMP_TARGET",
            Literal["timing", "area"],
            description="In area mode, the focus is area reduction, and timing may degrade. In delay mode, delay is likely reduced, but the area may increase",
            default="area",
        ),
        Variable(
            "RMP_SLACK_THRESHOLD",
            Optional[Decimal],
            description="Specifies a (setup) timing slack value below which timing paths need to be analyzed for restructuring",
            default=Decimal()
        ),
        Variable(
            "RMP_DEPTH_THRESHOLD",
            Optional[int],
            description="Specifies the path depth above which a timing path would be considered for restructuring",
        ),
    ]

    def get_script_path(self):
        return "~/gf180mcu-chess/restructure.tcl"

    def run(self, state_in: State, **kwargs) -> Tuple[ViewsUpdate, MetricsUpdate]:
        self.config = self.config.copy(DEFAULT_CORNER=self.config["RMP_CORNER"])

        kwargs, env = self.extract_env(kwargs)
        lib_list = self.toolbox.filter_views(
            self.config, self.config["LIB"], timing_corner=self.config.get("RMP_CORNER")
        )

        excluded_cells: Set[str] = set(self.config["EXTRA_EXCLUDED_CELLS"] or [])
        excluded_cells.update(
            process_list_file(self.config["SYNTH_EXCLUDED_CELL_FILE"])
        )
        excluded_cells.update(process_list_file(self.config["PNR_EXCLUDED_CELL_FILE"]))
        trimmed_lib = self.toolbox.remove_cells_from_lib(
            frozenset([str(lib) for lib in lib_list]),
            excluded_cells=frozenset(excluded_cells),
        )

        env["_RMP_LIB"] = TclStep.value_to_tcl(trimmed_lib)
        env["_RMP_ABC_LOG"] = TclStep.value_to_tcl(
            os.path.join(self.step_dir, "abc.log")
        )
        env["RMP_CORNER"] = TclStep.value_to_tcl(self.config.get("RMP_CORNER"))
        return super().run(state_in, env=env, **kwargs)

@Step.factory.register()
class RMPPlus(CompositeStep):
    id = "OpenROAD.RMPPlus"
    Steps = [
        RMP,
        Step.factory.get("OpenROAD.GlobalPlacement"),
        Step.factory.get("OpenROAD.DetailedPlacement"),
        Step.factory.get("OpenROAD.GlobalRouting"),
    ]
```


[12/22/2025 18:02] polyfractal
ooh interesting. where do "user plugins" live in the project template, and how do you specify where the step is inserted into the standard chip flow? Might be missing it from skimming that code but I don't think I see how it slots into the flow? Or is it run as a standalone step?


[12/22/2025 18:03] ravenslofty
anything which is in `PYTHONPATH`, and which has a filename which begins with `librelane_plugin_`


[12/22/2025 18:03] ravenslofty
(e.g. the above file is called `librelane_plugin_rmp.py`)


[12/22/2025 18:04] ravenslofty
> how do you specify where the step is inserted into the standard chip flow?
same as any other step in the flow; you add it in `librelane/config.yaml` under `substituting_steps`.


[12/22/2025 18:05] polyfractal
oh! I didn't realize that's what the `substituting_steps` section was for (makes sense in retrospect). awesome, thank you!


[12/22/2025 18:06] polyfractal
so just to check my understanding, for your `rmp` you would have nulled out the `GlobalPlacement`, `DetailedPlacement` and `GlobalRouting` , then inserted your `RMP` to run (and which includes the others)?


[12/22/2025 18:09] ravenslofty
actually, the intent was to run those, and then `OpenROAD.RMPPlus` afterwards to try to use the information


[12/22/2025 18:09] ravenslofty
||but RMP sucks, so it didn't help any||


[12/22/2025 18:10] polyfractal
hehe


[12/22/2025 18:10] polyfractal
gotcha üôÇ üëç


[12/22/2025 18:12] ravenslofty
I know it's quite insulting to call things like this *toys*, but having passes that have little documentation, only work in very specific situations and have crippling flaws, mixed in alongside the Serious Stuff for Serious People makes it confusing to know what to use


[12/22/2025 18:12] ravenslofty
*cough*


[12/22/2025 18:12] ravenslofty
anyway


[12/22/2025 18:14] polyfractal
state of documentation in general was a real hindrance to me personally (as a complete newbie). Even simple things, like is this parameter unitless? nanoseconds? percentage? who knows! üôÉ 

And even moreso for how parameters interact. optimizing was a lot of tweaking and seeing how it adjusted things


[12/22/2025 18:15] polyfractal
(not project template that is, Openroad/librelane)


[12/22/2025 18:16] polyfractal
that said I recognize docs are hard and no fun for OSS contributors üôÇ


[12/22/2025 18:16] ravenslofty
tbqh I have decided to do something very stupid in the hopes of improving gf180mcu performance :p


[12/22/2025 18:16] polyfractal
oh? any details to share or wait until the silicon is back?


[12/22/2025 18:17] ravenslofty
you might be aware that tholin's been working on a new standard cell library


[12/22/2025 18:18] ravenslofty
well, I've decided to make a new standard cell library too


[12/22/2025 18:18] ravenslofty
except I'm going with domino logic


[12/22/2025 18:20] polyfractal
oooh neat! will have to do some reading on that, only passingly familiar


[12/22/2025 18:28] polyfractal
(had a quick refresher, very cool! can't wait to see how it turns out üôÇ )


==============================================================
Exported 28 message(s)
==============================================================
